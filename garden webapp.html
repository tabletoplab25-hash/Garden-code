<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Garden Code ‚Äì Single Draw + Skip (EN rules)</title>
<style>
  :root{
    --g:#f5d580; --b:#1e7a2f; --a:#6fc0ff; --r:#8a96a6;
    --edge:#e9ecef; --ink:#213321; --tile:56px; --gap:4px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f2f7f2;color:var(--ink)}
  .wrap{max-width:1100px;margin:16px auto;padding:16px}
  h1{margin:0 0 8px;text-align:center}
  .setup,.panel{background:#fff;border:2px solid var(--edge);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .names{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-top:8px}
  input,select{padding:8px;border-radius:8px;border:1px solid var(--edge)}
  .btn{background:linear-gradient(180deg,#4a7c23,#2d5a27);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{background:#6c757d;cursor:not-allowed}
  .hidden{display:none}
  .panel{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .tag{background:#eef5ee;border:1px solid var(--edge);border-radius:10px;padding:4px 8px;font-size:12px}
  .boards{display:flex;flex-wrap:wrap;gap:12px}
  .card{background:#fff;border:2px solid var(--edge);border-radius:12px;padding:12px}

  .grid{display:grid;grid-template-columns:repeat(4,var(--tile));gap:var(--gap);background:#333;padding:var(--gap);border-radius:10px;width:max-content}
  .cell{width:var(--tile);height:var(--tile);border-radius:8px;background:#f8f9fa;border:2px solid var(--edge);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;position:relative}
  .cell.occ{cursor:not-allowed}
  .hl{outline:3px solid #ffd166}

  .tileView{width:120px;height:120px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:54px;position:relative;border:2px solid var(--edge);background:#fff;margin:auto}
  .ins{position:absolute;right:8px;bottom:6px;font-size:28px}

  .log{max-height:220px;overflow:auto;border:2px solid var(--edge);border-radius:10px;padding:8px;font-size:13px;background:#fff}

  /* Background like printable tiles */
  .bg-g{background:radial-gradient(40px 40px at 50% 35%, #fff2c2, var(--g));}
  .bg-b{background:radial-gradient(40px 40px at 50% 35%, #5cca74, var(--b));}
  .bg-a{background:radial-gradient(40px 40px at 50% 35%, #bfe6ff, var(--a));}
  .bg-r{background:radial-gradient(40px 40px at 50% 35%, #c2c9d6, var(--r));}

  /* Modal banner */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
  .modal.show{display:flex}
  .banner{max-width:720px;width:100%;background:#fff;border-radius:14px;border:2px solid var(--edge);padding:16px}
  .rules{display:grid;gap:8px}
  .rule{background:#f8fff8;border:1px solid var(--edge);border-left:6px solid #2d5a27;border-radius:10px;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üåø Garden Code ‚Äì Setup & Placement</h1>
  <!-- Screen 1 -->
  <section class="setup" id="screenSetup">
    <div class="row">
      <label>Players:
        <select id="playersSel"><option>2</option><option selected>3</option><option>4</option></select>
      </label>
      <button class="btn" id="startBtn">‚ñ∂ Start</button>
      <span class="tag">Game with 4 conditions each</span>
    </div>
    <div id="nameFields" class="names"></div>
  </section>
  <!-- Screen 2 -->
  <section class="panel hidden" id="screenGame">
    <div class="card">
      <div class="header">
        <div><b>Turn:</b> <span id="curName">-</span></div>
        <div class="row" style="gap:6px">
          <span class="tag">Round: <span id="round">1</span></span>
          <span class="tag">Bag: <span id="bagCount">0</span></span>
        </div>
      </div>
      <div id="boards" class="boards"></div>
    </div>
    <div class="card">
      <h3>Drawn Tile</h3>
      <div id="currentTile" class="tileView"></div>
      <div class="row" style="margin-top:8px;justify-content:center">
        <button class="btn" id="skipBtn">‚è≠Ô∏è Skip turn</button>
      </div>
      <h3 style="margin-top:12px">Log</h3>
      <div class="log" id="log"></div>
    </div>
  </section>
</div>

<!-- Banner -->
<div class="modal" id="rulesModal">
  <div class="banner">
    <h2 id="bannerTitle">Rules of ‚Ä¶</h2>
    <div class="rules" id="rulesList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="nextBanner">I wrote them down, next ‚ûú</button>
    </div>
  </div>
</div>

<script>
// ===== Data =====
const SIZE=4;
const HABS=['g','b','a','r']; // wheat, forest, water, rock
const HICON={g:'üåæ', b:'üå≤', a:'üíß', r:'üóø'};
const INSECTS=[null,'bee','but','fly']; // bee, butterfly, firefly
const IICON={bee:'üêù', but:'ü¶ã', fly:'‚ú®'};

// 10 Terrain (T1‚ÄìT10) + 10 Insect (I1‚ÄìI10) ‚Äî static, observable constraints
const RULES=[
 // Terrain
 {id:'T1',  t:'No Rock (üóø) on the four corners.'},
 {id:'T2',  t:'No Wheat (üåæ) on the four corners.'},
 {id:'T3',  t:'Main diagonal contains no Rock (üóø).'},
 {id:'T4',  t:'Center 2√ó2 cells are all different terrains.'},
 {id:'T5',  t:'No row has three identical terrains in a row.'},
 {id:'T6',  t:'No column has three identical terrains in a column.'},
 {id:'T7',  t:'Opposite corners cannot be the same terrain.'},
 {id:'T8',  t:'Even columns must contain at least one Wheat (üåæ).'},
 {id:'T9',  t:'Top edge contains no Water (üíß).'},
 {id:'T10', t:'Column 2 (from the left) contains no Rock (üóø).'},
 // Insect (orthogonal only)
 {id:'I1',  t:'No two Bees (üêù) are orthogonally adjacent.'},
 {id:'I2',  t:'No two Butterflies (ü¶ã) are orthogonally adjacent.'},
 {id:'I3',  t:'No two Fireflies (‚ú®) are orthogonally adjacent.'},
 {id:'I4',  t:'No insects on the four corners.'},
 {id:'I5',  t:'Center 2√ó2 contains at most one insect.'},
 {id:'I6',  t:'No row contains more than two insects.'},
 {id:'I7',  t:'No column contains more than two insects.'},
 {id:'I8',  t:'Top edge contains no insects.'},
 {id:'I9',  t:'In each row, insect types are all different (no duplicates).'},
 {id:'I10', t:'In each column, insect types are all different (no duplicates).'},
];

// ===== State & DOM =====
const S={ phase:'setup', players:[], active:0, round:1, bag:[], current:null, selCell:null, bannerIdx:0 };
const elPlayersSel=document.getElementById('playersSel');
const elNameFields=document.getElementById('nameFields');
const elStart=document.getElementById('startBtn');
const screenSetup=document.getElementById('screenSetup');
const screenGame=document.getElementById('screenGame');
const elCurName=document.getElementById('curName');
const elRound=document.getElementById('round');
const elBag=document.getElementById('bagCount');
const elBoards=document.getElementById('boards');
const elSkip=document.getElementById('skipBtn');
const elLog=document.getElementById('log');
const elModal=document.getElementById('rulesModal');
const elBannerTitle=document.getElementById('bannerTitle');
const elRulesList=document.getElementById('rulesList');
const elNextBanner=document.getElementById('nextBanner');
const elCurrentTile=document.getElementById('currentTile');

// ===== Helpers =====
function emptyBoard(){ return Array.from({length:SIZE},()=>Array.from({length:SIZE},()=>null)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function neigh(x,y){ return [[x+1,y],[x-1,y],[x,y+1],[x,y-1]]; }
function log(msg){ const p=document.createElement('div'); p.textContent=msg; elLog.prepend(p); }

// ===== Name inputs =====
function renderNameInputs(){ const n=parseInt(elPlayersSel.value,10); elNameFields.innerHTML=''; for(let i=0;i<n;i++){ const w=document.createElement('div'); const inp=document.createElement('input'); inp.placeholder=`Player ${i+1}`; inp.id=`name_${i}`; w.appendChild(inp); elNameFields.appendChild(w); } }
elPlayersSel.onchange=renderNameInputs; renderNameInputs();

// ===== Start =====
elStart.onclick=function(){
  const n=parseInt(elPlayersSel.value,10); const per=4; S.players=[];
  for(let i=0;i<n;i++){ const inp=document.getElementById(`name_${i}`); let name=(inp&&inp.value.trim())||`Player ${i+1}`; S.players.push({id:i,name,board:emptyBoard(),rules:[]}); }
  // assign rules: 4 per player from the 20-rule pool
  const ids=shuffle(RULES.map(r=>r.id)); let k=0; for(const p of S.players){ for(let j=0;j<per;j++){ p.rules.push(ids[(k++)%RULES.length]); } }
  // bag + first drawn tile
  S.bag=[]; for(let i=0;i<80;i++) S.bag.push(makeTile()); shuffle(S.bag);
  S.current=draw();
  S.phase='banner'; S.active=0; S.round=1; S.selCell=null; elLog.innerHTML='';
  screenSetup.classList.add('hidden'); screenGame.classList.remove('hidden');
  showBanner(0); renderAll();
};

// ===== Banner =====
function showBanner(idx){
  if(!S.players[idx]){ alert('Setup not valid'); return; }
  const p=S.players[idx];
  elBannerTitle.textContent=`Rules of ${p.name}`;
  elRulesList.innerHTML='';
  p.rules.forEach(rid=>{
    const R=RULES.find(x=>x.id===rid);
    const d=document.createElement('div');
    d.className='rule';
    d.textContent=`${rid} ‚Äì ${R.t}`;
    elRulesList.appendChild(d);
  });
  elModal.classList.add('show'); S.bannerIdx=idx;
}
elNextBanner.onclick=function(){
  const idx=S.bannerIdx;
  if(idx<S.players.length-1){ showBanner(idx+1); }
  else { elModal.classList.remove('show'); S.phase='play'; renderAll(); log('Game started. Turn of '+S.players[S.active].name+'.'); }
};

// ===== Tiles: single draw only =====
function makeTile(){
  const h=HABS[(Math.random()*HABS.length)|0]; // terrain
  const r=Math.random(); let ins=null;
  if(r<0.6){ const t=Math.random(); ins=t<0.34?'bee':(t<0.67?'but':'fly'); }
  return {h,ins};
}
function draw(){
  if(S.bag.length===0){
    for(let i=0;i<40;i++) S.bag.push(makeTile());
    shuffle(S.bag);
  }
  elBag.textContent=Math.max(0,S.bag.length-1);
  return S.bag.pop();
}

// ===== Render =====
function renderAll(){
  elCurName.textContent=S.players[S.active]?S.players[S.active].name:'-';
  elRound.textContent=S.round;
  elBag.textContent=S.bag.length;
  renderBoards();
  renderCurrentTile();
  elSkip.disabled=(S.phase!=='play');
}

function renderBoards(){
  elBoards.innerHTML='';
  S.players.forEach((p,idx)=>{
    const card=document.createElement('div'); card.className='card'; card.style.minWidth='260px';
    const head=document.createElement('div'); head.className='header'; head.innerHTML=`<b>${p.name}</b>`;
    card.appendChild(head);
    const grid=document.createElement('div'); grid.className='grid';
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      const cell=document.createElement('div'); cell.className='cell';
      const v=p.board[y][x];
      if(v){
        cell.classList.add('occ','bg-'+v.h);
        cell.textContent=HICON[v.h];
        const ins=document.createElement('div'); ins.className='ins'; ins.textContent=v.ins?IICON[v.ins]:'';
        cell.appendChild(ins);
      }
      if(idx===S.active && S.phase==='play' && !v){
        // highlight legal cells for the CURRENT drawn tile
        if(S.current && canPlace(p,x,y,S.current)) cell.classList.add('hl');
        cell.onclick=function(){ attemptPlace(x,y); };
      }
      grid.appendChild(cell);
    }
    card.appendChild(grid);
    elBoards.appendChild(card);
  });
}

function renderCurrentTile(){
  const ct=elCurrentTile;
  ct.className='tileView';
  if(!S.current){ ct.textContent='‚Äî'; return; }
  ct.classList.add('bg-'+S.current.h);
  ct.textContent=HICON[S.current.h];
  const ins=document.createElement('div'); ins.className='ins'; ins.textContent=S.current.ins?IICON[S.current.ins]:'';
  ct.appendChild(ins);
}

// ===== Placement / Skip =====
function canPlace(p,x,y,t){
  if(p.board[y][x]) return false;
  // first tile anywhere? (leaving as-is per request: do not change other rules)
  const any=p.board.some(row=>row.some(Boolean));
  if(!any) return true;
  // orthogonal adjacency to existing
  return neigh(x,y).some(([i,j])=>p.board[j] && p.board[j][i]);
}

function attemptPlace(x,y){
  if(S.phase!=='play' || !S.current) return;
  const me=S.players[S.active];
  if(!canPlace(me,x,y,S.current)) return;
  // place
  me.board[y][x]={h:S.current.h,ins:S.current.ins};
  log(`${me.name} placed ${HICON[S.current.h]} ${S.current.ins?`+ ${IICON[S.current.ins]}`:''} at (${x+1},${y+1}).`);
  // next tile for next player
  S.current=null;
  endTurn(true);
}

document.getElementById('skipBtn').onclick=function(){
  if(S.phase!=='play') return;
  log(S.players[S.active].name+' skipped the turn.');
  S.current=null;
  endTurn(false);
};

function endTurn(placed){
  const n=S.players.length;
  S.active=(S.active+1)%n;
  if(S.active===0) S.round++;
  // draw a fresh tile for the new active player
  S.current=draw();
  log('Turn of '+S.players[S.active].name+'. Drawn: '+HICON[S.current.h]+' '+(S.current.ins?IICON[S.current.ins]:''));
  renderAll();
}

// ===== init name inputs =====
</script>
</body>
</html>
